from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.ie.service import Service
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.support.ui import WebDriverWait
import re
import time
import pandas as pd



# ì™¼ìª½ í”„ë ˆì„ìœ¼ë¡œ ì „í™˜
def switch_left():
    driver.switch_to.parent_frame()
    # implicitly_waitë¡œ ëª»ì¡ê¸¸ë˜ ì•„ë˜ì²˜ëŸ¼ ë³€ê²½
    iframe = WebDriverWait(driver, 20).until(EC.presence_of_element_located((By.XPATH, '//*[@id="searchIframe"]')))
    driver.switch_to.frame(iframe)


# ì˜¤ë¥¸ìª½ í”„ë ˆì„ìœ¼ë¡œ ì „í™˜
def switch_right():
    driver.switch_to.parent_frame()
    try:
        # implicitly_waitë¡œ ëª»ì¡ê¸¸ë˜ ì•„ë˜ì²˜ëŸ¼ ë³€ê²½
        iframe = WebDriverWait(driver, 20).until(EC.presence_of_element_located((By.XPATH, '//*[@id="entryIframe"]')))
        driver.switch_to.frame(iframe)

        # ë‹¤ì‹œ í•œë²ˆë” í™•ì¸
    except Exception as e:
        iframe = WebDriverWait(driver, 20).until(EC.presence_of_element_located((By.XPATH, '//*[@id="entryIframe"]')))
        driver.switch_to.frame(iframe)


# ì˜ì—…ì‹œê°„ ì¶”ì¶œ
def find_business_hours():
    # ì˜ì—…ì‹œê°„ ë”ë³´ê¸° ë²„íŠ¼ ì°¾ê¸°
    WebDriverWait(driver, 3).until(
        EC.element_to_be_clickable((By.XPATH, '//div[@class="y6tNq"]/span'))
    ).click()

    # ì˜ì—… ì‹œê°„ ë”ë³´ê¸° ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë¶€ëª¨ìš”ì†Œ ë°œê²¬ë ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
    parent_element = WebDriverWait(driver, 1).until(
        EC.visibility_of_element_located((By.XPATH, '//a[@class="gKP9i RMgN0"]'))
    )

    # ë¶€ëª¨ìš”ì†Œ ë°œê²¬ë˜ë©´ ìì‹ìš”ì†Œ ì°¾ê¸°(ì˜ì—…ì¢…ë£Œ / ì˜ì—… ì¤‘ - ìš´ì˜ì‹œê°„ 00 ì— ì˜ì—… ì‹œì‘ì€ ì œì™¸)
    child_elements = parent_element.find_elements(By.XPATH,
                                                  './*[contains(@class, "w9QyJ")][position() > 1]')

    for child in child_elements:
        # ê° ìì‹ ìš”ì†Œ ë‚´ì—ì„œ div ì•ˆì— ìˆìœ¼ë©°, í´ë˜ìŠ¤ê°€ 'A_cdD'ì¸ ìš”ì†Œ ì°¾ê¸°
        span_elements = child.find_elements(By.XPATH, './div/*[@class="A_cdD"]')

        # ì°¾ì€ span ìš”ì†Œë“¤ì˜ í…ìŠ¤íŠ¸ ì¶œë ¥
        for span in span_elements:
            text = span.text
            if text and (store_name not in text) and ('ì ‘ê¸°' not in text):  # ë¹„ì–´ìˆì§€ ì•Šê³  store_nameì´ë‚˜ 'ì ‘ê¸°'ë¥¼ í¬í•¨í•˜ì§€ ì•ŠëŠ” ê²½ìš°
                business_hours.append(text)


# ë¸Œë¼ìš°ì € ì˜µì…˜
options = Options()
service = Service()
options.add_experimental_option("detach", True)  # êº¼ì§ ë°©ì§€ ì˜µì…˜
options.add_argument("disable-gpu")
options.add_argument("--no-sandbox")
options.add_argument("--disable-dev-shm-usage")
options.add_argument("--user-data-dir:C:/Work/cache")
options.add_argument("--disable-extensions")
options.add_argument("--disable-infobars")
options.add_argument('--incognito')

# í¬ë¡¬ ë“œë¼ì´ë²„ ì‹¤í–‰
driver = webdriver.Chrome(service=service, options=options)
driver.maximize_window()
# ë°˜ë³µ ì¢…ë£Œ ì¡°ê±´
loop = True

# ë„¤ì´ë²„ ì§€ë„ ë¡œë“œ
URL = 'https://map.naver.com/search/ì—°ë‚¨ë™ ë§›ì§‘'
driver.get(URL)
# 10ì´ˆ ì•ˆì— ì›¹ í˜ì´ì§€ë¥¼ ë¡œë“œí•˜ë©´ ë°”ë¡œ ë„˜ì–´ê°€ê±°ë‚˜, 10ì´ˆë¥¼ ê¸°ë‹¤ë¦¼
driver.implicitly_wait(10)

# ê°€ê²Œ ì •ë³´ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
stores = []
# ì²« ë²ˆì§¸ ì €ì¥ ì—¬ë¶€ë¥¼ ì¶”ì í•˜ëŠ” ë³€ìˆ˜
is_first_save = True

div = '//*[@id="app-root"]/div/div[3]/div[2]/'

franchise_values = ['ìŠ¤íƒ€ë²…ìŠ¤', 'ë©”ê°€MGC', 'ë©”ê°€ì»¤í”¼', 'í• ë¦¬ìŠ¤', 'ì»¤í”¼ë¹ˆ', 'í´ ë°”ì…‹', 'ì¹´í˜ë² ë„¤', 'ì—”ì œë¦¬ë„ˆìŠ¤', 'ì—”ì ¤ë¦¬ë„ˆìŠ¤', 'íˆ¬ì¸', 'íŒŒìŠ¤ì¿ ì°Œ', 'ë¹½ë‹¤ë°©', 'ë°”ë‚˜í”„ë ˆì†Œ', 'ì´ë””ì•¼', 'ì»´í¬ì¦ˆ', 'ë”ë²¤í‹°', 'ë”ë¦¬í„°', 'í•˜ì´ì˜¤ì»¤í”¼', 'ì˜¤ìŠ¬ë¡œìš°', 'ìŠ¤ë¬´ë””í‚¹', 'íƒì•¤íƒìŠ¤', 'í•˜ì‚¼ë™ì»¤í”¼', 'ì•„ë§ˆìŠ¤ë¹ˆ',
                    'íŒŒë¦¬ë°”ê²Œëœ¨', 'ëšœë ˆì¥¬ë¥´', 'íŒŒë¦¬í¬ë¼ìƒ',
                    'ë°°ìŠ¤í‚¨ë¼ë¹ˆìŠ¤', 'ìš”ê±°íŠ¸ì•„ì´ìŠ¤í¬ë¦¼ì˜ì •ì„', 'ìš”ì•„ì •', 'ë°±ë¯¸ë‹¹', 'ì„¤ë¹™', 'ë§ˆì´ìš”ê±°íŠ¸ë¦½', 'ìš”ê±°í”„ë ˆì†Œ', 'ìš”ê±°íŠ¸ì›”ë“œ',
                    'ë¸”ë£¨ë³´í‹€', 'í…Œë¼ë¡œì‚¬', 'íŒ€í™€íŠ¼', 'ì•„í‹°ì œ', 'ì»¤ìŠ¤í…€ì»¤í”¼', 'ì˜¤ì„¤ë¡', 'ê³ ë§ê³ ',
                    'í…í¼ì„¼íŠ¸', 'ì»¤í”¼ì—ë°˜í•˜ë‹¤', 'ì»¤í”¼ì‚¬í”¼ì—”ìŠ¤', 'ë´‰ëª…ë™ë‚´ì»¤í”¼',
                    'ë””ì €íŠ¸39', 'ê³µì°¨', 'ì¥¬ì”¨', 'ë§¤ë¨¸ë“œì»¤í”¼', 'ë§¤ë¨¸ë“œìµìŠ¤í”„ë ˆìŠ¤', 'íŒ”ê³µí‹°', 'ì¹´í˜ì¸ì¤‘ë…', 'í‚¤ì‰¬ë¯¸ë‡½', 'ì•„ë©”ë¦¬ì¹¸íŠ¸ë ˆì¼ëŸ¬', 'ì¹´í˜ì¸24', 'ì¹´í˜ì¼ë¶„', 'ìì—°ë“œë¦¼', 'ì¹´í˜ê²Œì´íŠ¸', 'ë°ì´ë¡±',
                    'ì¹´í˜ë§Œì›”ê²½', 'ì¹´í˜ ë§Œì›”ê²½', 'ë‚˜ì´ìŠ¤ì¹´í˜ì¸í´ëŸ½', 'ì‰¬ì¦ˆë² ì´ê¸€', 'ìš°ì§€ì»¤í”¼', 'ë°±ì–µì»¤í”¼',
                    'ì¤€ì½”', 'íƒ€ì½”ì•¼ë¼', 'íƒ€ì½”ì•¼í‚¤', 'ë§ˆë¦¬ì›¨ì¼']

not_category_values = [
    'ì•„ì´ìŠ¤í¬ë¦¼', 'ë¹™ìˆ˜', 'ë°€í‚¤íŠ¸', 'í…Œì´í¬ì•„ì›ƒì»¤í”¼', 'ë¼ì´ë¸Œì¹´í˜', 'ìŠ¤í„°ë””ì¹´í˜', 'ë¶ì¹´í˜',
    'ë‹¨ë€ì£¼ì ', 'ìœ í¥ì£¼ì ', 'í‘¸ë“œíŠ¸ëŸ­', 'í”„ëœì°¨ì´ì¦ˆë³¸ì‚¬', 'ë‹¤ë°©'
]

# ì •ê·œ í‘œí˜„ì‹ íŒ¨í„´ ìƒì„±
franchise_pattern = re.compile('|'.join(franchise_values), re.IGNORECASE)

while (loop):
    # searchIframe ìœ¼ë¡œ í”„ë ˆì„ ë³€ê²½
    switch_left()

    try:
        # ë‹¤ìŒ í˜ì´ì§€ true, false ì—¬ë¶€ í™•ì¸
        # ë‹¤ìŒ í˜ì´ì§€ê°€ disabled ì†ì„±ì¸ì§€ [true / false]
        # í˜ì´ì§€ ë„˜ê¸¸ë•Œë§ˆë‹¤ ê³„ì† í™•ì¸í•´ì¤˜ì•¼ í•¨(í˜ì´ì§€ ìƒˆë¡œ ë¡œë“œ ì‹œ, ë²„íŠ¼ ìƒíƒœ ê°’ì´ ë°”ë€œ)
        # [@id="app-root"]/div/div[3] ì¸ì§€ [@id="app-root"]/div/div[2]ì¸ì§€ ê³„ì† í™•ì¸í•´ì•¼ë  í•„ìš”ê°€ ìˆìŒ
        next_page = driver.find_element(By.XPATH, div + 'a[7]').get_attribute(
            'aria-disabled')
        print("next_page ê°’ :" + str(next_page))

    except Exception as e:
        div = '//*[@id="app-root"]/div/div[2]/div[2]/'
        next_page = driver.find_element(By.XPATH, div + 'a[7]').get_attribute(
            'aria-disabled')
        print("next_page ê°’ :" + str(next_page))

    # í˜„ì¬ page ìˆ«ì ê°€ì ¸ì˜¤ê¸°
    page_no = driver.find_element(By.XPATH, '//a[contains(@class, "mBN2s qxokY")]').text

    if page_no == '3':
        # ë“œë¼ì´ë²„ ë„ê³ 
        driver.quit()
        # ë“œë¼ì´ë²„ ì´ˆê¸°í™”
        driver = webdriver.Chrome(service=service, options=options)
        driver.maximize_window()
        # ë„¤ì´ë²„ ì§€ë„ ë‹¤ì‹œ ë¡œë“œ
        driver.get(URL)
        # 10ì´ˆ ì•ˆì— ì›¹ í˜ì´ì§€ë¥¼ ë¡œë“œí•˜ë©´ ë°”ë¡œ ë„˜ì–´ê°€ê±°ë‚˜, 10ì´ˆë¥¼ ê¸°ë‹¤ë¦¼
        driver.implicitly_wait(10)
        switch_left()
        # 3 í˜ì´ì§€ë¥¼ í´ë¦­í•©ë‹ˆë‹¤.
        driver.find_element(By.XPATH, div + 'a[4]').click()
        print("3 í˜ì´ì§€ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.")
        page_no = driver.find_element(By.XPATH, '//a[contains(@class, "mBN2s qxokY")]').text

    # ë§¨ ë°‘ê¹Œì§€ ìŠ¤í¬ë¡¤
    scrollable_element = driver.find_element(By.XPATH,
                                                 '// *[ @ id = "_pcmap_list_scroll_container"]')  # ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆ ì°¾ê¸°
    last_height = driver.execute_script("return arguments[0].scrollHeight", scrollable_element)
    while True:
        # ìš”ì†Œ ë‚´ì—ì„œ ì•„ë˜ë¡œ 650px ìŠ¤í¬ë¡¤
        driver.execute_script("arguments[0].scrollTop += 650;", scrollable_element)

        # í˜ì´ì§€ ë¡œë“œë¥¼ ê¸°ë‹¤ë¦¼
        time.sleep(1)

        # ìƒˆ ë†’ì´ ê³„ì‚°
        new_height = driver.execute_script("return arguments[0].scrollHeight", scrollable_element)
        # ìŠ¤í¬ë¡¤ì´ ë” ì´ìƒ ëŠ˜ì–´ë‚˜ì§€ ì•Šìœ¼ë©´ ë£¨í”„ ì¢…ë£Œ
        if new_height == last_height:
            break

        last_height = new_height

    # í˜„ì¬ í˜ì´ì§€ì— ë“±ë¡ëœ ëª¨ë“  ê°€ê²Œ ì¡°íšŒ
    # ê´‘ê³  ê±¸ë¦° ì—…ì²´ë“¤ì€ ë˜ ì¶œë ¥ë˜ê¸° ë•Œë¬¸ì— ê±°ë¦…ë‹ˆë‹¤.
    restaurant_elements = driver.find_elements(By.XPATH,
                                                   '//*[@id="_pcmap_list_scroll_container"]//li[@data-laim-exp-id="undefinedundefined"]')

    # í˜ì´ì§€ë‹¹ 70ê°œ ì •ë„ì˜ ê°€ê²Œê°€ ì¶œë ¥ë¨
    print('í˜„ì¬ ' + str(page_no) + ' í˜ì´ì§€, ' + 'ì´ ' + str(len(restaurant_elements)) + 'ê°œì˜ ê°€ê²Œë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.')
    switch_left()

    # ë½‘ì•„ë†“ì€ elements ë“¤ ë°˜ë³µí•´ì„œ ëŒê¸°
    for index, e in enumerate(restaurant_elements, start=1):
        store_name = ''  # ê°€ê²Œ ì´ë¦„
        category = ''  # ì¹´í…Œê³ ë¦¬
        store_id = ''  # ê°€ê²Œ ê³ ìœ  ë²ˆí˜¸
        address = ''  # ê°€ê²Œ ì£¼ì†Œ
        amenity = ''  # í¸ì˜
        option = ''  # ë¯¸ì‰ë¦°, ì°©í•œ ê°€ê²Œ
        business_hours = []  # ì˜ì—… ì‹œê°„
        broadcast = []  # ë°©ì†¡
        menu = []  # ë©”ë‰´
        tel = ''  # ì „í™”ë²ˆí˜¸

        switch_left()  # ë‹¤ì‹œ ì™¼ìª½ í”„ë ˆì„ìœ¼ë¡œ ëŒì•„ì™€ì•¼ í•¨
        e.find_element(By.XPATH, './div[@class="CHC5F"]').find_element(By.XPATH, './div[@class="bSoi3"]/a').click()
        driver.implicitly_wait(3)
        switch_right()
        driver.implicitly_wait(3)

        # ì—¬ê¸°ë¶€í„° í¬ë¡¤ë§ ì‹œì‘
        # ì œëª© í‘œì‹œë˜ëŠ” ë¶€ë¶„
        try:
            title = WebDriverWait(driver, 10).until(
                EC.presence_of_element_located((By.XPATH, '//div[@class="zD5Nm undefined"]'))
            )
        except Exception as e:
            print("íƒ€ì´í‹€ ì¶”ì¶œ ì‹¤íŒ¨")
            time.sleep(1)
            #driver.refresh()  # ì‚¬ì´íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª» í•˜ëŠ” ê²½ìš°ê°€ ìˆì–´ì„œ ìƒˆë¡œê³ ì¹¨ ì½”ë“œ ì¶”ê°€
            #switch_right()
            title = WebDriverWait(driver, 10).until(
                EC.presence_of_element_located((By.XPATH, '//div[@class="zD5Nm undefined"]'))
            )

        # ê°€ê²Œì´ë¦„ / ì¹´í…Œê³ ë¦¬ / ë¯¸ì‰ë¦°,ì°©í•œê°€ê²©ì—…ì†Œ,ì‹ì•½ì²˜ì¸ì¦ìš°ìˆ˜ìŒì‹ì  ì—¬ë¶€
        try:
            store_name = title.find_element(By.XPATH, './/div[1]/div[1]/span[1]').text  # ê°€ê²Œ ì´ë¦„
            category = title.find_element(By.XPATH, './/div[1]/div[1]/span[2]').text  # ì¹´í…Œê³ ë¦¬
            option = title.find_element(By.CSS_SELECTOR, 'div.XtBbS').text  # ë¯¸ì‰ë¦° ë˜ëŠ” ì°©í•œ ê°€ê²© ë˜ëŠ” ì‹ì•½ì²˜ ì¸ì¦ ìš°ìˆ˜ ìŒì‹ì 
        except Exception as e:
            store_name = title.find_element(By.XPATH, './/div[1]/div[1]/span[1]').text  # ê°€ê²Œ ì´ë¦„
            category = title.find_element(By.XPATH, './/div[1]/div[1]/span[2]').text  # ì¹´í…Œê³ ë¦¬

        # ğŸ‘‰ í”„ëœì°¨ì´ì¦ˆ ê°€ê²ŒëŠ” ìŠ¤í‚µ
        if franchise_pattern.search(store_name):
            print(f"í”„ëœì°¨ì´ì¦ˆ ê°€ê²Œ ìŠ¤í‚µ: {store_name}")
            continue  # ë‹¤ìŒ ê°€ê²Œë¡œ ë„˜ì–´ê°

        # ì¹´í…Œê³ ë¦¬ í•„í„°ë§
        if category in not_category_values:
            print(f"ì œì™¸ ì¹´í…Œê³ ë¦¬ ìŠ¤í‚µ: {store_name} (ì¹´í…Œê³ ë¦¬: {category})")
            continue # ë‹¤ìŒ ê°€ê²Œë¡œ ë„˜ì–´ê°

        # ì£¼ì†Œ
        try:
            address = driver.find_element(By.CLASS_NAME, 'LDgIH').text
        except Exception as e:
            print(store_name + " : ì£¼ì†Œ ì¶”ì¶œ ì˜¤ë¥˜")
            address = driver.find_element(By.CLASS_NAME, 'LDgIH').text

        # ì „í™”ë²ˆí˜¸
        try:
            tel = driver.find_element(By.CLASS_NAME, 'xlx7Q').text
        except Exception as e:
            # íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ì—°ê²°í•´ë†“ì€ ê°€ê²Œ
            try:
                print(store_name + " : ì „í™”ë²ˆí˜¸ê°€ ì—†ë‚˜?")
                tel_box = driver.find_element(By.XPATH,
                                                  '//div[contains(@class, "O8qbU nbXkr")]//div[@class="mqM2N"]')
                if tel_box:
                    print(store_name + " : tel_boxë¥¼ ì°¾ìŒ")
                    tel_box_a = tel_box.find_element(By.XPATH, './/a')
                    tel_box_a.click()
                    print("tel_box_aëŠ” ëˆŒë €ìŒ")
                    tel = tel_box.find_element(By.XPATH,
                                                   './/div[contains(@class, "_YI7T kH0zp")]/div[@class="J7eF_"]/em').text
            # ì „í™”ë²ˆí˜¸ ì§„ì§œ ì—†ìŒ
            except Exception as e:
                print(store_name + " : ì „í™”ë²ˆí˜¸ ì—†ìŒ")

        # ì˜ì—…ì‹œê°„
        try:
            find_business_hours()

            # business_hoursê°€ ë¹„ì–´ìˆê±°ë‚˜ ê°’ì´ ì—†ëŠ” ê²½ìš° ìŠ¤í¬ë¡¤ ë‚´ë¦¬ê¸°
            if not any(business_hours):
                driver.execute_script("window.scrollBy(0, 600);")  # í™”ë©´ì— ë³´ì´ì§€ ì•ŠëŠ” ê²½ìš°ë¥¼ ê³ ë ¤í•˜ì—¬ 600px ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
                time.sleep(1)  # ì ì‹œ ëŒ€ê¸°
                find_business_hours()

        except Exception as e:
            print(store_name + " : ì˜ì—…ì‹œê°„ ì§„ì§œ ì—†ìŒ")

        # í¸ì˜
        try:
            # ì¼ë‹¨ ëŒ€ê¸°
            driver.implicitly_wait(3)
            container = driver.find_element(By.XPATH,
                                                '//div[@class="PIbes"]/div[contains(@class, "O8qbU") and contains(@class, "Uv6Eo")]/div')
            amenity = container.text
        except Exception as e:
            try:
                # print("í¸ì˜ì‹œì„¤ ì¶”ì¶œ ì˜¤ë¥˜")
                driver.execute_script("window.scrollBy(0, 600);")  # í™”ë©´ì— ë³´ì´ì§€ ì•ŠëŠ” ê²½ìš°ë¥¼ ê³ ë ¤í•˜ì—¬ 600px ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
                time.sleep(1)  # ì ì‹œ ëŒ€ê¸°

                container = driver.find_element(By.XPATH,
                                                    '//div[@class="PIbes"]/div[contains(@class, "O8qbU") and contains(@class, "Uv6Eo")]')
                amenity = container.text
            except Exception as e:
                print(store_name + " : í¸ì˜ì‹œì„¤ ì§„ì§œ ì—†ìŒ")

        # ë°©ì†¡ ì¶œì—°
        try:
            try:  # ìš°ì„  ë°©ì†¡ì¶œì—° ë¸”ëŸ­ ì°¾ê¸°
                tv_box = driver.find_element(By.XPATH, 'div.O8qbU.TMK4W')

            except Exception as e:
                # ë°©ì†¡ ì¶œì—° ë¸”ëŸ­ì´ ì•ˆ ì°¾ì•„ì§„ë‹¤ë©´ ìŠ¤í¬ë¡¤ ë‚´ë¦¬ê¸°
                driver.execute_script("window.scrollBy(0, 600);")  # í™”ë©´ì— ë³´ì´ì§€ ì•ŠëŠ” ê²½ìš°ë¥¼ ê³ ë ¤í•˜ì—¬ 600px ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
                time.sleep(1)  # ì ì‹œ ëŒ€ê¸°

                tv_box = driver.find_element(By.CSS_SELECTOR, 'div.O8qbU.TMK4W')  # ë‹¤ì‹œ ë°©ì†¡ì¶œì—° ë¸”ëŸ­ ì°¾ê¸°

            exclude_indices = list(range(len(business_hours)))
            if tv_box:
                tv_box.click()
                tv_text = tv_box.find_elements(By.XPATH,
                                                   '//div[@class="vV_z_"]//div[@class="w9QyJ"]/div[@class="y6tNq"]/*[@class="A_cdD"]')

                for index, span in enumerate(tv_text):
                    if index in exclude_indices:  # ì²« ë²ˆì§¸ ìš”ì†Œë¥¼ ì œì™¸
                        continue
                    broad_text = span.text
                    broadcast.append(broad_text)

        except Exception as e:
            print(store_name + " : ë°©ì†¡ì¶œì—° í•œì  ì—†ìŠµë‹ˆë‹¤.")

        # ê°€ê²Œ ê³ ìœ  ì•„ì´ë””
        try:
            wait = WebDriverWait(driver, 10)
            store_element = wait.until(EC.presence_of_element_located(
                (By.XPATH, '//a[contains(@href, "/restaurant/") and contains(@class, "_tab-menu")]')
            ))

            href = store_element.get_attribute('href')

            match = re.search(r'/restaurant/(\d+)', href)
            store_id = match.group(1) if match else None
        except Exception as e:
            print("ì•„ì´ë””ëª»ì°¾ìŒ")
            switch_right()  # í”„ë ˆì„ ë²—ì–´ë‚œ ê²½ìš°ë¥¼ ê³ ë ¤
            wait = WebDriverWait(driver, 10)
            store_element = wait.until(EC.presence_of_element_located(
                (By.XPATH, '//a[contains(@href, "/restaurant/") and contains(@class, "_tab-menu")]')
            ))

            href = store_element.get_attribute('href')

            match = re.search(r'/restaurant/(\d+)', href)
            store_id = match.group(1) if match else None
        # ë©”ë‰´
        try:
            # ë©”ë‰´ íƒ­ ì°¾ê¸°
            is_menu = WebDriverWait(driver, 10).until(
                EC.element_to_be_clickable((By.XPATH, '//div[contains(@class, "place_fixed_maintab")]//a[span[normalize-space()="ë©”ë‰´"]]')
            ))
            if is_menu:
                is_menu.click()

                # 1. ë„¤ì´ë²„ ì§€ë„ ë‚´ ë©”ë‰´
                try:
                    body = WebDriverWait(driver, 3).until(  # ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆ ì°¾ê¸°
                            EC.presence_of_element_located((By.XPATH,
                                                            '//div[contains(@class, "place_section") and contains(@class, "no_margin")]/div[@class="place_section_content"]'))
                    )
                    # ì´ˆê¸° ìŠ¤í¬ë¡¤ ë†’ì´ ì„¤ì •
                    previous_scroll_height = 0

                    while True:
                        driver.execute_script("arguments[0].scrollTop = arguments[0].scrollHeight", body)
                        time.sleep(1)  # ìŠ¤í¬ë¡¤ í›„ ë¡œë”© ì‹œê°„ ëŒ€ê¸°

                        try:
                            WebDriverWait(driver, 3).until(
                                EC.element_to_be_clickable((By.XPATH, '//div[@class="lfH3O"]'))
                            ).click()  # ë”ë³´ê¸° ë²„íŠ¼ ì°¾ê¸°

                        except Exception as e:
                            # ë”ë³´ê¸° ë²„íŠ¼ì´ ì—†ìœ¼ë©´ ìŠ¤í¬ë¡¤ ë‚´ë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤.
                            break

                        # í˜„ì¬ ìŠ¤í¬ë¡¤ ë†’ì´ ê°€ì ¸ì˜¤ê¸°
                        new_scroll_height = driver.execute_script("return arguments[0].scrollHeight", body)

                        # ì´ì „ ìŠ¤í¬ë¡¤ ë†’ì´ì™€ ë¹„êµ
                        if new_scroll_height == previous_scroll_height:  # ì´ì „ ìŠ¤í¬ë¡¤ ë†’ì´ì™€ ê°™ë‹¤ë©´ ë” ì´ìƒ ìŠ¤í¬ë¡¤í•  ë‚´ìš©ì´ ì—†ë‹¤
                            break

                        # í˜„ì¬ ìŠ¤í¬ë¡¤ ë†’ì´ë¥¼ ì´ì „ ìŠ¤í¬ë¡¤ ë†’ì´ë¡œ ì—…ë°ì´íŠ¸
                        previous_scroll_height = new_scroll_height

                    ul_element = body.find_element(By.XPATH, './/ul')  # body ì•ˆì— ul ìš”ì†Œ ì°¾ê¸°
                    driver.implicitly_wait(10)
                    li_elements = ul_element.find_elements(By.XPATH, './li[@class="E2jtL"]/a')  # ul ì•ˆì— li ìš”ì†Œ ì°¾ê¸°

                    if li_elements:
                        # ê° li ì•ˆì˜ div[@class="MXkFw"] ìš”ì†Œì˜ í…ìŠ¤íŠ¸ ì¶œë ¥ span ìš”ì†Œë“¤ì˜ í…ìŠ¤íŠ¸ ì¶œë ¥
                        for li in li_elements:
                            menu_elements = li.find_elements(By.XPATH, './div[@class="MXkFw"]')

                            for single_menu in menu_elements:
                                text = single_menu.text
                                if text:  # ë¹„ì–´ìˆì§€ ì•Šì€ ê²½ìš°
                                    menu.append(text)

                # 2. ë„¤ì´ë²„ ì£¼ë¬¸(í¬ì¥ + ë°°ë‹¬)
                except Exception as e:
                    try:
                        # print("ë°°ë‹¬ ê°€ëŠ¥ ë©”ë‰´ì…ë‹ˆë‹¤.")
                        body = WebDriverWait(driver, 3).until(
                            EC.presence_of_element_located((By.XPATH, '//div[@class="order_list"]'))
                        )
                        menu_container = body.find_elements(By.XPATH,
                                                            '//div[@class="order_list_inner"]/ul[@class="order_list_area"]/li[@class="order_list_item"]//div[@class="info_detail"]')
                        for menus in menu_container:
                            text = menus.text
                            menu.append(text)

                    # 3. ë°°ë‹¬ ì£¼ë¬¸
                    except Exception as e:
                        body = driver.find_element(By.XPATH, '//div[@data-nclicks-area-code="bmv"]')
                        # ì´ˆê¸° ë†’ì´ ì„¤ì •
                        previous_scroll_height = 0
                        while True:
                            driver.execute_script("arguments[0].scrollTop = arguments[0].scrollHeight", body)
                            time.sleep(1)  # ìŠ¤í¬ë¡¤ í›„ ë¡œë”© ì‹œê°„ ëŒ€ê¸°

                            try:
                                button = driver.find_elements(By.XPATH,
                                                              '//div[@class="NSTUp"]/div[@class="lfH3O"]/a[@class="fvwqf"]').click()  # ë”ë³´ê¸° ë²„íŠ¼ ì°¾ê¸°
                            except Exception as e:
                                # ë”ë³´ê¸° ë²„íŠ¼ì´ ì—†ìœ¼ë©´ ìŠ¤í¬ë¡¤ ë‚´ë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤.
                                break

                            # í˜„ì¬ ìŠ¤í¬ë¡¤ ë†’ì´ ê°€ì ¸ì˜¤ê¸°
                            new_scroll_height = driver.execute_script("return arguments[0].scrollHeight", body)

                            # ì´ì „ ìŠ¤í¬ë¡¤ ë†’ì´ì™€ ë¹„êµ
                            if new_scroll_height == previous_scroll_height:  # ì´ì „ ìŠ¤í¬ë¡¤ ë†’ì´ì™€ ê°™ë‹¤ë©´ ë” ì´ìƒ ìŠ¤í¬ë¡¤í•  ë‚´ìš©ì´ ì—†ë‹¤
                                break

                            # í˜„ì¬ ìŠ¤í¬ë¡¤ ë†’ì´ë¥¼ ì´ì „ ìŠ¤í¬ë¡¤ ë†’ì´ë¡œ ì—…ë°ì´íŠ¸
                            previous_scroll_height = new_scroll_height

                        menu_container = body.find_elements(By.XPATH,
                                                            '//div[contains(@class, "place_section") and contains(@class, "gkWf3")]/div[@class="place_section_content"]')

                        # ê° ë©”ë‰´ ì»¨í…Œì´ë„ˆì—ì„œ ul ìš”ì†Œë¥¼ ì°¾ê¸°
                        for container in menu_container:
                            ul_element = container.find_elements(By.XPATH, './/ul')

                            for ul in ul_element:
                                driver.implicitly_wait(10)
                                li_elements = ul.find_elements(By.XPATH, './li/a')  # ul ì•ˆì— li ìš”ì†Œ ì°¾ê¸°

                                if li_elements:
                                    for li in li_elements:
                                        menu_elements = li.find_elements(By.XPATH, './div[@class="MXkFw"]')

                                        for single_menu in menu_elements:
                                            text = single_menu.text
                                            if text:  # ë¹„ì–´ìˆì§€ ì•Šë‹¤ë©´
                                                menu.append(text)


        except Exception as e:
            print(store_name + " : ë©”ë‰´ ì§„ì§œ ì—†ìŒ")

        # ì €ì¥í•  ì •ë³´
        stores_info = {
            'store_id': store_id,
            'name': store_name,
            'category': category,
            'address': address,
            'tel': tel,
            'options': option,
            'amenity': amenity,
            'broadcast': '; '.join(broadcast),
            'business_hours': '; '.join(business_hours),
            'menu': '; '.join(menu)
        }

        stores.append(stores_info)

    if stores:
        df = pd.DataFrame(stores)
        df.to_csv('ë§ˆí¬êµ¬/ì—°ë‚¨ë™ ë§›ì§‘.csv', mode='a', encoding='utf-8-sig', index=False, header=is_first_save)

        # ì²« ë²ˆì§¸ ì €ì¥ ì´í›„ì—ëŠ” is_first_saveë¥¼ falseë¡œ ë³€ê²½
        is_first_save = False

        print("íŒŒì¼ ì €ì¥ ì™„ë£Œ")
        del stores
        stores = []

        # mode='a' íŒŒì¼ì„ ì—´ì–´ì„œ ê¸°ì¡´ ë°ì´í„° ë’¤ì— ìƒˆë¡œìš´ ë°ì´í„°ë¥¼ ì¶”ê°€í•œë‹¤
        # íŒŒì¼ì´ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±í•œë‹¤
        # ê¸°ì¡´ì˜ ë‚´ìš©ì„ ì§€ìš°ì§€ ì•Šê³ , ìƒˆë¡œìš´ ë‚´ìš©ì„ ì¶”ê°€í•˜ëŠ” ë° ì‚¬ìš©ëœë‹¤.

        # mode='w' íŒŒì¼ì„ ì—´ì–´ì„œ ê¸°ì¡´ ë‚´ìš©ì„ ëª¨ë‘ ì§€ìš°ê³  ìƒˆë¡œìš´ ë‚´ìš©ì„ ì‘ì„±í•œë‹¤.
        # íŒŒì¼ì´ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±í•œë‹¤.
        # ê¸°ì¡´ì˜ ë°ì´í„°ëŠ” ì‚­ì œë˜ë¯€ë¡œ ì£¼ì˜

    switch_left()

    # í˜ì´ì§€ ë‹¤ìŒ ë²„íŠ¼ì´ í™œì„±í™” ìƒíƒœì¼ ê²½ìš° ê³„ì† ì§„í–‰
    if (next_page == 'false'):
        driver.find_element(By.XPATH, div + 'a[7]').click()
        print("ë‹¤ìŒ í˜ì´ì§€ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.")
    # ì•„ë‹ ê²½ìš° ë£¨í”„ ì •ì§€
    else:
        loop = False

driver.close()

#######################ì—¬ê¸° ê¹Œì§€ ############################
